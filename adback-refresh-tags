#!/bin/bash
#            _ _                _
#   __ _  __| | |__   __ _  ___| | __
#  / _` |/ _` | '_ \ / _` |/ __| |/ /
# | (_| | (_| | |_) | (_| | (__|   < 
#  \__,_|\__,_|_.__/ \__,_|\___|_|\_\
#

if [ -z "$1" ] ; then
    printf "\nUsage: ${0} [token]\n"
    printf "Check out adback.co panel to get your token.\n\n"
    exit 1
fi

FILE=$(wget -qO- https://adback.co/api/script/me?access_token=$1\&_format=yml)

if [ -z "$FILE" ] ; then
    printf "\nCan't access to  https://adback.co/api/script/me?access_token=${1}&_format=yml\n\n"
    printf "Please verifying this step:\n"
    printf "	1) Is your token valid ?                 ->  wget https://adback.co/api/doc?access_token=${1}\n"
    printf "	2) Are our servers reachable ?           ->  ping adback.co\n"
    printf "	3) Check out docs for the latest version ->  http://docs.adback.co/en/latest/\n\n"
    exit 1
fi

analytics_domain=$(echo $FILE | tr " " "\n" | awk '/analytics_domain/{getline; print}')

analytics_script_name=$(echo $FILE | tr " " "\n" | awk '/analytics_script/{getline; print}')

message_domain=$(echo $FILE | tr " " "\n" | awk '/message_domain/{getline; print}')

message_script_name=$(echo $FILE | tr " " "\n" | awk '/message_script/{getline; print}')

if [ -z "$analytics_domain" ] || [ -z "$analytics_script_name" ] || [ -z "$message_domain" ] \
    || [ -z "$message_script_name" ] ; then
    printf "\nWrong api datas, please try again later.\n\n"
    printf "Check out docs for the latest version -> http://docs.adback.co/en/latest/\n\n"
    exit 1
fi

#Analytics script
analytics_script=$(cat <<EOF
<script>
    (function (a,d){var s,t;s=d.createElement('script');
    s.src=a;s.async=1;
    t=d.getElementsByTagName('script')[0];
    t.parentNode.insertBefore(s,t);
    })("https://${analytics_domain}/${analytics_script_name}.js", document);
</script>
EOF
)

#Analytics script
message_script=$(cat <<EOF
<script>
    (function (a,d){var s,t,u;s=d.createElement(‘script’);
    if(d.referrer){u=d.createElement('a');u.href=d.referrer;a=a+u.hostname;}
    s.src=a;s.async=1;
    t=d.getElementsByTagName('script')[0];
    t.parentNode.insertBefore(s,t);
    })("https://${message_domain}/${message_script_name}.js?ref=", document);
</script>
EOF
)

printf "\n----- Analytics script -----\n"
echo $analytics_script
printf "\n----------------------------\n"

printf "\n----- Analytics script -----\n"
echo $message_script
printf "\n----------------------------\n\n"
